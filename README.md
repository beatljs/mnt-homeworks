
---
<img src="Netology.png" height="24px"/>

### Учебная группа DevOps-32

---

## Решение по домашнему заданию к занятию 4 «Работа с roles»


- [Описание](#description)
- [Требования к инфраструктуре](#requirements)
- [Переменные и настройки](#vars-and-setup)
- [Запуск](#play)
- [Исполнитель](#student)

---

###### Description
### Описание

Здесь приводится исходный код `ansible-playbook`, выполняющий установку DB `Clickhouse`, транспортировщика логов `Vector` и `lighthouse` для отображения логов.

Playbook написан для выполнения домашнего задания 4 в рамках обучения работе с `Ansible` и базируется на коде `playbook` из домашнего задания 3.

В развитие навыков работы с `ansible` в настоящем `playbook` `task` оформлены в виде `roles` и в самом `playbook` вместо написания `task` вызываются роли.

Роль для развертывания `clickhouse` - скачивается с git по ссылке из файла с ДЗ.

Учебные роли для `vector` и `lighthouse` написаны самостоятельно на базе `playbook` из задания 3 и выложены на GitHub. Ссылки для скачивания и номера рабочих версий укзаны в файле `requirements.yml`   

---

###### Requirements
### Требования к инфрастуктуре

Для успешного запуска и выполнения настоящего playbook требуется создать в облаке три виртуальных машины с ОС Linux.
1. clickhouse-01 - VM для развертывания clickhouse: 2 CPU, 4 Gb RAM, 20 Gb HDD 
2. vector-01 - VM для развертывания vector: 2 CPU, 2 Gb RAM, 20 Gb HDD
3. lighthouse-01 - VM для развертывания lighthouse: 2 CPU, 2 Gb RAM, 20 Gb HDD

Загрузить роли, выполнив команду.

```
ansible-galaxy install -f -r requirements.yml
```
---

###### Vars and Setup
### Переменные и настройки

Перед запуском `playbook` требуется его предварительная настройка.
Настройка производится путем создания корректного inventory файла и задания переменных.

Окружение на котором запускается playbook - настраивается в файле `/inventory/prod.yml`

В группе `clickhouse` указывается хост на котором должен быть развернут `clickhouse`,

в группе `vector` - хост(ы) где должен быть развернут `vector`,

В группе `lighthouse` - хост где должен быть развернут `lighthouse`.

IP адреса хостов и имена пользователей берутся из облака в соответствии с созданными VM. 

---

###### Play
### Запуск

Запуск playbook: 

``` 
ansible-playbook --flush-cache -i inventory/prod.yml site.yml`
```

запуск должен производиться из каталога `playbook` содержащего файл `site.yml` 

<details>
    <summary> Вывод ansible...  </summary>

```
beatl@OWEN:~/mnt-homeworks/04/playbook$ ansible-playbook --flush-cache -i inventory/prod.yml site.yml

PLAY [Install Clickhouse] **********************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Include OS Family Specific Variables] ***************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/precheck.yml for clickhouse-01

TASK [clickhouse : Requirements check | Checking sse4_2 support] *******************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Requirements check | Not supported distribution && release] *****************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/params.yml for clickhouse-01

TASK [clickhouse : Set clickhouse_service_enable] **********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Set clickhouse_service_ensure] **********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/install/apt.yml for clickhouse-01

TASK [clickhouse : Install by APT | Apt-key add repo key] **************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by APT | Remove old repo] *******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by APT | Repo installation] *****************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by APT | Package installation] **************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by APT | Package installation] **************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Hold specified version during APT upgrade | Package installation] ***********************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
ok: [clickhouse-01] => (item=clickhouse-common-static)

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/configure/sys.yml for clickhouse-01

TASK [clickhouse : Check clickhouse config, data and logs] *************************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=/var/log/clickhouse-server)
ok: [clickhouse-01] => (item=/etc/clickhouse-server)
ok: [clickhouse-01] => (item=/var/lib/clickhouse/tmp/)
ok: [clickhouse-01] => (item=/var/lib/clickhouse/)

TASK [clickhouse : Config | Create config.d folder] ********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Create users.d folder] *********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate system config] ********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate users config] *********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate remote_servers config] ************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Generate macros config] ********************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Generate zookeeper servers config] *********************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Fix interserver_http_port and intersever_https_port collision] *****************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Notify Handlers Now] ********************************************************************************************************************************************************************************************

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/service.yml for clickhouse-01

TASK [clickhouse : Ensure clickhouse-server.service is enabled: True and state: started] *******************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Wait for Clickhouse Server to Become Ready] *********************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/configure/db.yml for clickhouse-01

TASK [clickhouse : Set ClickHose Connection String] ********************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Gather list of existing databases] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Delete database config] ********************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Create database config] ********************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
included: /home/beatl/.ansible/roles/clickhouse/tasks/configure/dict.yml for clickhouse-01

TASK [clickhouse : Config | Generate dictionary config] ****************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] **************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]

PLAY [Install Vector] **************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector-role : Vector | Get distrib] ******************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector-role : Vector | Install package] **************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector-role : Vector | Configure | ensure what config directory exists] ******************************************************************************************************************************************************
ok: [vector-01]

TASK [vector-role : Vector | Configure | Template config] **************************************************************************************************************************************************************************
changed: [vector-01]

TASK [vector-role : Vector | Prepare and setup unit from template] *****************************************************************************************************************************************************************
changed: [vector-01]

TASK [vector-role : Vector | Flush handlers] ***************************************************************************************************************************************************************************************

RUNNING HANDLER [vector-role : Vector | Restart Service] ***************************************************************************************************************************************************************************
changed: [vector-01]

TASK [vector-role : Vector | Create Log Dir] ***************************************************************************************************************************************************************************************
changed: [vector-01]

PLAY [Install lighthouse] **********************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************
The authenticity of host '84.201.161.171 (84.201.161.171)' can't be established.
ECDSA key fingerprint is SHA256:+BzVIvlhqwEaThlNtIOvONSHdLTB/NMxGigih+3l3d0.
Are you sure you want to continue connecting (yes/no)? yes
ok: [lighthouse-01]

TASK [lighthouse-role : Lighthouse | Nginx | Install from apt] *********************************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [lighthouse-role : Lighthouse | Install unzip] ********************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse-role : Lighthouse | Download zip package] *************************************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [lighthouse-role : Lighthouse | Unarch zip package to nginx homedir] **********************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [lighthouse-role : Make nginx config] *****************************************************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [lighthouse-role : Lighthouse | Delete zip package] ***************************************************************************************************************************************************************************
changed: [lighthouse-01]

RUNNING HANDLER [lighthouse-role : Lighthouse | Restart Nginx Service] *************************************************************************************************************************************************************
changed: [lighthouse-01]

PLAY RECAP *************************************************************************************************************************************************************************************************************************
clickhouse-01              : ok=26   changed=0    unreachable=0    failed=0    skipped=10   rescued=0    ignored=0   
lighthouse-01              : ok=8    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector-01                  : ok=8    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```
</details>

---

###### Student
### Исполнитель

Сергей Жуков DevOps-32

---


