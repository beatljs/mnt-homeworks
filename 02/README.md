
---
<img src="Netology.png" height="24px"/>

### Учебная группа DevOps-32

---

## Решение по домашнему заданию к занятию 2 «Работа с Playbook»

- [Описание](#description)
- [Требования к ПК](#requirements)
- [Переменные и настройки](#vars-and-setup)
- [Запуск и постнастройка](#play-and-post-tuning)
- [Тестирование](#testing)
- [Исполнитель](#student)

---

###### Description
### Описание

Здесь приводится исходный код `ansible-playbook`, выполняющий установку DB `Clickhouse` и транспортировщика логов `Vector`.

Playbook написан для выполнения домашнего задания в рамках обучения работе с `Ansible`.

---

###### Requirements
### Требования к ПК

Debian GNU/Linux 11 (bullseye) amd64

Ansible 2.10.8

Python version = 3.9.2

---

###### Vars and Setup
### Переменные и настройки

Перед запуском `playbook` требуется его предварительная настройка.
Настройка производится путем задания переменных.

Окружение на котором запускается playbook - настраивается в файле `/inventory/prod.yml`

В группе `clickhouse` указывается хост на котором должен быть развернут `clickhouse`,

в группе `vector` - хост(ы) где должен быть развернут vector

В соответствующих файлах `vars.yml` указываются версии, названия пакетов и url для скачивания пакаджей clickhouse и vector.

Также в файле `vars.yml` для `vector` указываются:

- `vector_config_dir:` место хранения конфигурации `vector`, 
- `vector_log_dir:` место расположения файлов `*.log` из которых `vector` считывает данные мониторинга,
- `db_name:` название базы данных `clickhouse`, где будут храниться данные мониторинга,
- `db_table:` название таблицы в БД `clickhouse`, где будут храниться данные мониторинга,
- `db_user:` имя пользователя для БД
- `db_pass:` пароль пользователя БД
  
(открыто пароль хранить здесь неправильно, лучше воспользоваться `ansible-vault`)

Конфигурации `vector` и `unit` для запуска `vеctor` в качестве сервиса, создаются на базе шаблонов `jinja2` из каталога `template` 

---

###### Play and post tuning
### Запуск и постнастройка

Запуск playbook: `sudo ansible-playbook -i inventory/prod.yml site.yml`

запуск должен производиться из каталога `playbook` содержащего файл `site.yml` 

После успешного выполнения нужно убедиться с помощью `sudo systemctl status ...` в том, что сервисы `clickhouse-server` и `vector` стартовали без ошибок.

_Т. к. настоящий `playbook` создавался в учебных целях, то для того, чтобы заработала связка `clickhouse-vector`, требуется провести **ручные** настройки `clickhouse`:_
- запустить из консоли `clickhouse-client`
- создать пользователя `<db_user> `с паролем `<db_pass>` и соответствующими правами
- создать таблицу `<db_table>` в БД `<db_name>`
```
CREATE TABLE <db_name>.<db_table>
(
    `file` String,
    `host` String,
    `message` String,
    `source_type` String,
    `timestamp` DateTime
)
ENGINE = Log
```
- перезапустить сервис `vector` и убедиться что _healthcheck_ прошел без ошибок.

_Все эти настройки делаются вручную только в учебной версии, в production версии `ansible` должна все это выполнять автоматически._

---

###### Testing
### Тестирование

Из консоли создать `(echo > ..., touch ...)` в каталоге `playbook/logs/` любой файл `*.log` с произвольным содержимым.
Произвести запись в файл любой текстовой информации. Открыть еще одно окно консоли, в нем запустить `clickhouse-client` и убедиться, что записываемая в файл информация появляется в базе данных.

```
┌─file────────────────────────────────────────────────┬─host─────┬─message─────┬─source_type─┬───────────timestamp─┐
│ /home/beatl/mnt-homeworks/02/playbook/logs/log1.log │ ProBookB │ Test_entryZ │ file        │ 2023-09-05 19:35:46 │
└─────────────────────────────────────────────────────┴──────────┴─────────────┴─────────────┴─────────────────────┘
```

---

###### Student
### Исполнитель

Сергей Жуков DevOps-32

---


